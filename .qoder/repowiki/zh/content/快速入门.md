# 快速入门

<cite>
**本文档中引用的文件**  
- [MainForm.Designer.cs](file://InstallerPlugin/MainForm.Designer.cs)
- [MainForm.cs](file://InstallerPlugin/MainForm.cs)
- [Program.cs](file://InstallerPlugin/Program.cs)
- [CADPlugin.cs](file://CADPlugin.cs)
- [MenuManager.cs](file://MenuManager.cs)
- [BatchUpgradeProjectForm.Designer.cs](file://WinformUI/UpgradeProject/BatchUpgradeProjectForm.Designer.cs)
- [BatchUpgradeProjectForm.cs](file://WinformUI/UpgradeProject/BatchUpgradeProjectForm.cs)
- [BatchUpdateTableForm.Designer.cs](file://WinformUI/UpdateTable/BatchUpdateTableForm.Designer.cs)
- [BatchUpdateTableForm.cs](file://WinformUI/UpdateTable/BatchUpdateTableForm.cs)
- [LogManager.cs](file://MyOffice/LogHelper/LogManager.cs)
</cite>

## 目录
1. [简介](#简介)
2. [安装与注册插件](#安装与注册插件)
3. [启动AutoCAD并加载功能](#启动autocad并加载功能)
4. [执行批量升级操作](#执行批量升级操作)
5. [执行批量更新表格操作](#执行批量更新表格操作)
6. [常见问题与解决方案](#常见问题与解决方案)
7. [附录：日志查看](#附录日志查看)

## 简介

本指南旨在帮助新手用户快速上手使用“DCSDesign2025”工具集。该工具集提供了一系列用于批量处理工程图纸的功能，包括批量升级、批量更新表格等。通过本指南，您将学习如何安装插件、配置环境、启动功能以及完成一次完整的端到端操作。

**重要前提条件**：
- 已安装 .NET Framework 4.8 或更高版本。
- 已正确安装 AutoCAD 2022、2023 或 2024 版本之一。
- 当前用户对 AutoCAD 安装目录具有读写权限（特别是注册表访问权限）。
- 操作系统为 Windows 10 或更高版本。

## 安装与注册插件

要使用本工具的所有功能，首先需要通过 `InstallerPlugin` 将插件部署到目标 AutoCAD 版本中，并完成必要的注册表配置。

### 步骤一：运行安装程序
1. 找到并双击运行 `InstallerPlugin.exe` 文件。
2. 启动后，您将看到一个名为“DCSDesign2025 插件安装工具”的窗口。

### 步骤二：选择AutoCAD版本
在主界面中，找到“选择AutoCAD版本”区域：
- 勾选您希望部署插件的 AutoCAD 版本（支持 2022、2023、2024）。
- 默认情况下，“AutoCAD 2022”被选中。

### 步骤三：执行安装或卸载
- **安装插件**：点击“安装插件”按钮。程序会自动检查所选版本是否已安装，并尝试在当前用户的注册表路径下创建相应的应用程序条目。
- **卸载插件**：若需移除插件，请点击“卸载插件”按钮，系统将删除对应的注册表项。

### 注册表配置说明
安装过程会在以下注册表路径中添加键值（以 HKCU 为例）：
```
HKEY_CURRENT_USER\SOFTWARE\Autodesk\AutoCAD\<版本号>\<产品>\Applications\DCSDesign2025
```
关键键值包括：
- `LOADCTRLS`: 控制加载方式（值为 2 表示随 AutoCAD 启动时加载）
- `MANAGED`: 指定为托管代码（值为 1）
- `LOADER`: 指向插件 DLL 的完整路径

安装成功后，会弹出提示框：“插件已成功安装到 XXXX。下次启动AutoCAD时，插件将自动加载。”

**Section sources**
- [MainForm.Designer.cs](file://InstallerPlugin/MainForm.Designer.cs#L6-L166)
- [MainForm.cs](file://InstallerPlugin/MainForm.cs#L72-L194)
- [Program.cs](file://InstallerPlugin/Program.cs#L8-L20)

## 启动AutoCAD并加载功能

完成插件安装后，按照以下步骤启动 AutoCAD 并激活相关命令：

1. 启动您之前选择版本的 AutoCAD 应用程序。
2. 插件将在后台自动初始化。您可以在命令行中观察到如下输出信息：
   ```
   工程图纸批量更新工具已加载
   使用命令 "BATCHUPGRADE" 启动工程图纸批量更新工具
   使用命令 "BATCHUPDATETABLE" 启动批量更新表格工具
   或者在菜单栏中的 "DCS工程工具" 菜单下选择相应的命令
   ```

3. 检查菜单栏是否新增了“DCS设计2025”菜单项。该菜单由 `MenuManager` 类动态生成，包含以下子命令：
   - 批量修改工程图纸(BATCHUPGRADE)
   - 批量更新表格(BATCHUPDATETABLE)
   - 更新图框标记值(UPDATEFRAME)

这些命令均通过 `[CommandMethod]` 属性在 `CADPlugin` 类中定义，确保其可在 AutoCAD 会话中调用。

**Section sources**
- [CADPlugin.cs](file://CADPlugin.cs#L29-L320)
- [MenuManager.cs](file://MenuManager.cs#L13-L135)

## 执行批量升级操作

本节演示如何使用 `BATCHUPGRADE` 命令完成一次完整的批量升级流程。

### 步骤一：启动功能
在 AutoCAD 命令行输入：
```
BATCHUPGRADE
```
回车后，将弹出“工程图纸批量改版工具”主界面。

### 步骤二：配置参数
1. **选择图纸文件夹**  
   点击“浏览...”按钮，选择包含 DWG 和 Word 文档的根目录。

2. **设置替换规则**  
   在“常规设置”选项卡中，使用“添加”按钮创建替换规则。每条规则包含：
   - 原文本（查找内容）
   - 新文本（替换内容）
   - 规则类型（“相等”或“包含”）

   支持从 CSV 文件导入或导出规则以便复用。

3. **配置DWG处理选项**  
   切换至“DWG文件设置”选项卡，勾选需要处理的对象类型：
   - 文字（单行、多行）
   - 表格内容
   - 块属性（图框属性）
   - 可选：降成A版本（自动重置版本列和日期）

4. **配置Word文档选项**  
   在“生成A版封面页”选项卡中，可设置项目名称、编号、内部编码等字段的替换逻辑，并控制是否重置审批表格。

5. **启用备份**  
   建议勾选“处理前备份文件”，以防误操作导致数据丢失。

### 步骤三：开始处理
点击“开始处理”按钮，程序将：
1. 自动备份原文件夹（如启用）
2. 遍历所有 `.dwg` 和 `.docx` 文件
3. 根据规则批量修改文件名、内容及图框属性
4. 实时更新进度条和状态信息

处理完成后，会弹出结果摘要，并询问是否查看详细日志。

**Section sources**
- [BatchUpgradeProjectForm.Designer.cs](file://WinformUI/UpgradeProject/BatchUpgradeProjectForm.Designer.cs#L2-L911)
- [BatchUpgradeProjectForm.cs](file://WinformUI/UpgradeProject/BatchUpgradeProjectForm.cs#L504-L671)

## 执行批量更新表格操作

此功能允许在 Excel 数据与 CAD 表格之间进行双向同步。

### 启动功能
在 AutoCAD 命令行输入：
```
BATCHUPDATETABLE
```
打开“批量更新表格工具”界面。

### 配置映射关系
1. **指定图纸集目录**  
   点击“浏览”选择包含多个子项目的总目录。

2. **定义映射规则**  
   在网格中配置 DWG 关键字（或表格标题）与 Excel 工作表名称之间的对应关系。例如：
   - DWG关键字: `INDEX` → Excel工作表: `INDEX`
   - CAD表格标题: `-E01` → Excel工作表: `CQ100`

3. **选择更新方向**  
   - **Excel → CAD**：将 Excel 中的数据写入 CAD 表格
   - **CAD → Excel**：从 CAD 表格提取数据并生成 Excel 文件

4. **其他选项**  
   - 创建备份：建议开启
   - 合并单元格：适用于复杂表格结构

### 执行更新
点击“更新”按钮，确认操作后程序将逐个处理每个图纸集。处理过程中，日志窗口会实时显示进度和结果。

**Section sources**
- [BatchUpdateTableForm.Designer.cs](file://WinformUI/UpdateTable/BatchUpdateTableForm.Designer.cs#L5-L78)
- [BatchUpdateTableForm.cs](file://WinformUI/UpdateTable/BatchUpdateTableForm.cs#L0-L605)

## 常见问题与解决方案

以下是安装和使用过程中可能遇到的问题及其解决方法：

| 问题现象 | 可能原因 | 解决方案 |
|--------|--------|--------|
| 安装失败，提示“未检测到已安装的 AutoCAD” | 所选版本未安装或注册表信息缺失 | 确认 AutoCAD 已正确安装；检查注册表路径是否存在 |
| 命令无法识别（如 BATCHUPGRADE 无效） | 插件未成功加载或注册表配置错误 | 重新运行 InstallerPlugin 进行安装；重启 AutoCAD |
| 处理过程中程序崩溃 | 输入文件损坏或内存不足 | 检查源文件完整性；关闭其他大型程序释放资源 |
| 日志中出现“权限不足”错误 | 用户无权写入目标目录或注册表 | 以管理员身份运行 AutoCAD；检查文件夹权限设置 |
| 替换规则未生效 | 规则类型选择错误或文本匹配不准确 | 使用“包含”模式进行模糊匹配；检查大小写和空格 |

**特别注意**：如果多次尝试仍无法解决问题，请检查 `logs\application.log` 和 `logs\error.log` 文件获取详细错误堆栈。

**Section sources**
- [LogManager.cs](file://MyOffice/LogHelper/LogManager.cs#L0-L143)

## 附录：日志查看

所有操作均会被记录到日志文件中，便于排查问题和审计流程。

- **日志位置**：位于程序运行目录下的 `logs` 文件夹内。
- **主要日志文件**：
  - `application.log`：常规运行日志
  - `error.log`：仅记录错误和严重异常
- **查看方式**：可用记事本或其他文本编辑器打开。

此外，在每次批量处理结束后，系统还会生成一个独立的“处理日志_时间戳.txt”文件，存放在输出目录的 `Logs` 子文件夹中，包含本次任务的完整执行记录。

**Section sources**
- [BatchUpgradeProjectForm.cs](file://WinformUI/UpgradeProject/BatchUpgradeProjectForm.cs#L742-L776)
- [LogManager.cs](file://MyOffice/LogHelper/LogManager.cs#L70-L99)